{% extends "base.html" %}
{% block title %}{{ product.name or product.url }} - Price Checker{% endblock %}
{% block content %}
<h1 style="margin-bottom: 1rem;">{{ product.name or "Product" }}</h1>

<div class="card">
    <p><strong>URL:</strong> <a href="{{ product.url }}" target="_blank">{{ product.url }}</a></p>
    <p style="margin-top: 0.5rem;"><strong>Status:</strong>
        <span id="detail-status">
        {% if product.last_status == "available" %}
            <span class="status available">Available</span>
        {% elif product.last_status == "unavailable" %}
            <span class="status unavailable">Unavailable</span>
        {% else %}
            <span class="status unknown">Pending</span>
        {% endif %}
        </span>
    </p>
    <p style="margin-top: 0.5rem;"><strong>Price:</strong> <span id="detail-price">{{ "$%.2f"|format(product.last_price) if product.last_price is not none else "—" }}</span></p>
    <p style="margin-top: 0.5rem;"><strong>Last Checked:</strong> <span id="detail-checked">{{ product.last_checked.strftime("%Y-%m-%d %H:%M:%S") if product.last_checked else "—" }}</span></p>
    <form method="post" action="/product/{{ product.id }}/delete" style="margin-top: 1rem;" onsubmit="return confirm('Remove this product and all its history?');">
        <button type="submit" class="btn btn-danger">Remove Product</button>
    </form>
</div>

<h2 style="margin-bottom: 1rem;">Check History</h2>

<div id="history-section">
{% if history %}
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Status</th>
            <th>Price</th>
        </tr>
    </thead>
    <tbody id="history-body">
        {% for h in history %}
        <tr>
            <td>{{ h.checked_at.strftime("%Y-%m-%d %H:%M:%S") }}</td>
            <td>
                {% if h.status == "available" %}
                    <span class="status available">Available</span>
                {% elif h.status == "unavailable" %}
                    <span class="status unavailable">Unavailable</span>
                {% else %}
                    <span class="status unknown">{{ h.status }}</span>
                {% endif %}
            </td>
            <td>{{ "$%.2f"|format(h.price) if h.price is not none else "—" }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty">
    <p>No check history yet. Waiting for next scheduled check.</p>
</div>
{% endif %}
</div>

<script>
(function() {
    var productId = {{ product.id }};
    function statusBadge(s) {
        if (s === "available") return '<span class="status available">Available</span>';
        if (s === "unavailable") return '<span class="status unavailable">Unavailable</span>';
        return '<span class="status unknown">' + (s || "Pending") + '</span>';
    }
    function fmtPrice(p) {
        return p != null ? "$" + Number(p).toFixed(2) : "\u2014";
    }
    function refresh() {
        fetch("/api/product/" + productId)
            .then(function(r) { return r.ok ? r.json() : null; })
            .then(function(d) {
                if (!d) return;
                document.getElementById("detail-status").innerHTML = statusBadge(d.last_status);
                document.getElementById("detail-price").textContent = fmtPrice(d.last_price);
                document.getElementById("detail-checked").textContent = d.last_checked || "\u2014";
                if (d.history && d.history.length) {
                    var rows = d.history.map(function(h) {
                        return "<tr><td>" + h.checked_at + "</td><td>" + statusBadge(h.status) + "</td><td>" + fmtPrice(h.price) + "</td></tr>";
                    }).join("");
                    var section = document.getElementById("history-section");
                    section.innerHTML = '<table><thead><tr><th>Time</th><th>Status</th><th>Price</th></tr></thead><tbody id="history-body">' + rows + '</tbody></table>';
                }
            })
            .catch(function() {});
    }
    setInterval(refresh, 30000);
})();
</script>
{% endblock %}
