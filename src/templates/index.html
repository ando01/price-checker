{% extends "base.html" %}
{% block title %}Dashboard - Price Checker{% endblock %}
{% block content %}
<h1 style="margin-bottom: 1rem;">Monitored Products</h1>

{% if products %}
<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Status</th>
            <th>Price</th>
            <th>Last Checked</th>
        </tr>
    </thead>
    <tbody id="product-body">
        {% for p in products %}
        <tr data-id="{{ p.id }}">
            <td><a href="/product/{{ p.id }}">{{ p.name or p.url }}</a></td>
            <td>
                {% if p.last_status == "available" %}
                    <span class="status available">Available</span>
                {% elif p.last_status == "unavailable" %}
                    <span class="status unavailable">Unavailable</span>
                {% else %}
                    <span class="status unknown">Pending</span>
                {% endif %}
            </td>
            <td>{{ "$%.2f"|format(p.last_price) if p.last_price is not none else "—" }}</td>
            <td>{{ p.last_checked.strftime("%Y-%m-%d %H:%M") if p.last_checked else "—" }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty" id="empty-state">
    <p>No products being monitored yet.</p>
    <p style="margin-top: 0.5rem;"><a href="/add" class="btn">Add Product</a></p>
</div>
{% endif %}

<script>
(function() {
    function statusBadge(s) {
        if (s === "available") return '<span class="status available">Available</span>';
        if (s === "unavailable") return '<span class="status unavailable">Unavailable</span>';
        return '<span class="status unknown">' + (s || "Pending") + '</span>';
    }
    function fmtPrice(p) {
        return p != null ? "$" + Number(p).toFixed(2) : "\u2014";
    }
    function refresh() {
        fetch("/api/products")
            .then(function(r) { return r.ok ? r.json() : null; })
            .then(function(products) {
                if (!products) return;
                var tbody = document.getElementById("product-body");
                if (!tbody) return;
                var rows = products.map(function(p) {
                    var name = p.name || p.url;
                    return '<tr data-id="' + p.id + '">'
                        + '<td><a href="/product/' + p.id + '">' + name + '</a></td>'
                        + '<td>' + statusBadge(p.last_status) + '</td>'
                        + '<td>' + fmtPrice(p.last_price) + '</td>'
                        + '<td>' + (p.last_checked || "\u2014") + '</td>'
                        + '</tr>';
                }).join("");
                tbody.innerHTML = rows;
            })
            .catch(function() {});
    }
    setInterval(refresh, 30000);
})();
</script>
{% endblock %}
