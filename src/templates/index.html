{% extends "base.html" %}
{% block title %}Dashboard - Price Checker{% endblock %}
{% block content %}
<h1 style="margin-bottom: 1rem;">Monitored Products</h1>

<div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
    <div class="card" style="flex: 1; min-width: 200px; margin-bottom: 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <strong>Availability Checker</strong>
            <span id="avail-badge" class="status unknown">Loading</span>
        </div>
        <div id="avail-countdown" style="font-size: 0.9rem; color: #6c757d;">—</div>
        <form method="post" action="/settings/availability" style="margin-top: 0.6rem; display: flex; align-items: center; gap: 0.5rem;">
            <label for="avail-interval" style="font-size: 0.85rem; white-space: nowrap;">Interval (min):</label>
            <input type="number" id="avail-interval" name="interval" min="0" value="{{ avail_interval }}"
                   style="width: 65px; padding: 0.2rem 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85rem;">
            <button type="submit" class="btn" style="padding: 0.2rem 0.6rem; font-size: 0.85rem;">Save</button>
        </form>
    </div>
    <div class="card" style="flex: 1; min-width: 200px; margin-bottom: 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <strong>Price Checker</strong>
            <span id="price-badge" class="status unknown">Loading</span>
        </div>
        <div id="price-countdown" style="font-size: 0.9rem; color: #6c757d;">—</div>
        <form method="post" action="/settings/price" style="margin-top: 0.6rem; display: flex; align-items: center; gap: 0.5rem;">
            <label for="price-interval" style="font-size: 0.85rem; white-space: nowrap;">Interval (min):</label>
            <input type="number" id="price-interval" name="price_interval" min="0" value="{{ price_interval }}"
                   style="width: 65px; padding: 0.2rem 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85rem;">
            <button type="submit" class="btn" style="padding: 0.2rem 0.6rem; font-size: 0.85rem;">Save</button>
        </form>
    </div>
</div>

{% if products %}
<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Status</th>
            <th>Price</th>
            <th>Last Checked</th>
            <th>Checks</th>
        </tr>
    </thead>
    <tbody id="product-body">
        {% for p in products %}
        <tr data-id="{{ p.id }}">
            <td><a href="/product/{{ p.id }}">{{ p.name or p.url }}</a></td>
            <td>
                {% if p.last_status == "available" %}
                    <span class="status available">Available</span>
                {% elif p.last_status == "unavailable" %}
                    <span class="status unavailable">Unavailable</span>
                {% else %}
                    <span class="status unknown">Pending</span>
                {% endif %}
            </td>
            <td>{{ "$%.2f"|format(p.last_price) if p.last_price is not none else "—" }}</td>
            <td>{{ p.last_checked.strftime("%Y-%m-%d %H:%M") if p.last_checked else "—" }}</td>
            <td>
                <label style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.25rem; cursor: pointer; white-space: nowrap;">
                    <input type="checkbox" class="check-toggle" data-id="{{ p.id }}" data-field="check_availability" {{ "checked" if p.check_availability }}>
                    Avail
                </label>
                <label style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.25rem; cursor: pointer; white-space: nowrap; margin-top: 0.2rem;">
                    <input type="checkbox" class="check-toggle" data-id="{{ p.id }}" data-field="check_price" {{ "checked" if p.check_price }}>
                    Price
                </label>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty" id="empty-state">
    <p>No products being monitored yet.</p>
    <p style="margin-top: 0.5rem;"><a href="/add" class="btn">Add Product</a></p>
</div>
{% endif %}

<script>
(function() {
    function statusBadge(s) {
        if (s === "available") return '<span class="status available">Available</span>';
        if (s === "unavailable") return '<span class="status unavailable">Unavailable</span>';
        return '<span class="status unknown">' + (s || "Pending") + '</span>';
    }
    function fmtPrice(p) {
        return p != null ? "$" + Number(p).toFixed(2) : "\u2014";
    }
    function checkboxCell(id, ca, cp) {
        return '<td>'
            + '<label style="font-size:0.8rem;display:flex;align-items:center;gap:0.25rem;cursor:pointer;white-space:nowrap;">'
            + '<input type="checkbox" class="check-toggle" data-id="' + id + '" data-field="check_availability"' + (ca ? ' checked' : '') + '> Avail'
            + '</label>'
            + '<label style="font-size:0.8rem;display:flex;align-items:center;gap:0.25rem;cursor:pointer;white-space:nowrap;margin-top:0.2rem;">'
            + '<input type="checkbox" class="check-toggle" data-id="' + id + '" data-field="check_price"' + (cp ? ' checked' : '') + '> Price'
            + '</label>'
            + '</td>';
    }

    function refreshProducts() {
        fetch("/api/products")
            .then(function(r) { return r.ok ? r.json() : null; })
            .then(function(products) {
                if (!products) return;
                var tbody = document.getElementById("product-body");
                if (!tbody) return;
                var rows = products.map(function(p) {
                    var name = p.name || p.url;
                    return '<tr data-id="' + p.id + '">'
                        + '<td><a href="/product/' + p.id + '">' + name + '</a></td>'
                        + '<td>' + statusBadge(p.last_status) + '</td>'
                        + '<td>' + fmtPrice(p.last_price) + '</td>'
                        + '<td>' + (p.last_checked || "\u2014") + '</td>'
                        + checkboxCell(p.id, p.check_availability, p.check_price)
                        + '</tr>';
                }).join("");
                tbody.innerHTML = rows;
            })
            .catch(function() {});
    }
    setInterval(refreshProducts, 30000);

    /* --- Per-product check toggles (event delegation survives AJAX re-render) --- */
    document.addEventListener('change', function(e) {
        var cb = e.target;
        if (!cb.classList.contains('check-toggle')) return;
        var id = cb.dataset.id;
        var field = cb.dataset.field;
        var body = {};
        body[field] = cb.checked;
        fetch('/api/product/' + id + '/checks', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        }).catch(function() {
            cb.checked = !cb.checked; // revert on error
        });
    });

    /* --- Checker status & countdowns --- */
    var checkerState = { availability: null, price: null };

    function fmtCountdown(secs) {
        if (secs == null || secs < 0) return "\u2014";
        var m = Math.floor(secs / 60);
        var s = secs % 60;
        return m + "m " + (s < 10 ? "0" : "") + s + "s";
    }

    function renderBadge(el, active) {
        if (active) {
            el.className = "status available";
            el.textContent = "Active";
        } else {
            el.className = "status unavailable";
            el.textContent = "Paused";
        }
    }

    function renderCountdown(el, info) {
        if (!info || !info.active) {
            el.textContent = "Paused";
            return;
        }
        el.textContent = "Next check in " + fmtCountdown(info.seconds_remaining)
            + " (every " + info.interval_minutes + "m)";
    }

    function fetchStatus() {
        fetch("/api/status")
            .then(function(r) { return r.ok ? r.json() : null; })
            .then(function(data) {
                if (!data) return;
                checkerState.availability = data.availability;
                checkerState.price = data.price;
                renderBadge(document.getElementById("avail-badge"), data.availability.active);
                renderBadge(document.getElementById("price-badge"), data.price.active);
            })
            .catch(function() {});
    }

    function tick() {
        ["availability", "price"].forEach(function(key) {
            var info = checkerState[key];
            var elId = key === "availability" ? "avail-countdown" : "price-countdown";
            if (info && info.active && info.seconds_remaining != null) {
                info.seconds_remaining = Math.max(0, info.seconds_remaining - 1);
            }
            renderCountdown(document.getElementById(elId), info);
        });
    }

    fetchStatus();
    setInterval(fetchStatus, 15000);
    setInterval(tick, 1000);
})();
</script>
{% endblock %}
